<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Samemo ‚Äî Entr√©e Stock</title>

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#fff;
  --border:#e5e7eb;
  --disabled:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
}
.app{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.header{text-align:center;margin-bottom:20px}
.logo{font-size:26px;font-weight:800;color:var(--primary)}
.subtitle{font-size:14px;color:#475569}
.card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
}
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:#eff6ff;
  color:var(--primary);
  font-weight:600;
  margin-bottom:12px;
}
label{font-size:13px;font-weight:600;margin-top:12px;display:block}
input{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
}
input[readonly]{background:#f1f5f9}
button{
  width:100%;
  margin-top:18px;
  padding:16px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}
#scanBtn{background:var(--primary);color:#fff}
#confirmBtn{background:var(--disabled);color:#fff}
#confirmBtn.enabled{background:var(--success)}
#confirmBtn:disabled{cursor:not-allowed}
#message{text-align:center;font-weight:600;margin-top:10px}
.products{margin-top:16px;display:flex;flex-direction:column;gap:12px}
.product-card{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  display:flex;
  gap:12px;
  align-items:center;
}
.product-card img{
  width:60px;height:60px;border-radius:10px;object-fit:cover
}
.remove-btn{background:none;border:none;font-size:20px;cursor:pointer}
.hidden{display:none}
.success-icon{font-size:48px;color:var(--success);text-align:center}
ul{padding-left:18px}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <div class="logo">SAMEMO</div>
  <div class="subtitle">Entr√©e de stock ‚Üí Zone STOCK</div>
</div>

<!-- FORM -->
<div id="screen-form" class="card">
  <div class="badge">üì• Entr√©e Stock</div>

  <label>Acteur</label>
  <input id="actor" readonly>

  <label>Source</label>
  <input id="from" readonly value="RECEPTION">

  <label>Destination</label>
  <input id="to" readonly value="STOCK">

  <div id="qr-reader" style="width:100%;margin-top:12px;"></div>
  <div id="message"></div>

  <button type="button" id="scanBtn">üì∑ Scanner un produit</button>

  <div id="products" class="products"></div>

  <button id="confirmBtn" disabled>CONFIRMER L‚ÄôENTR√âE</button>
</div>

<!-- SUCCESS -->
<div id="screen-success" class="card hidden">
  <div class="success-icon">‚úÖ</div>
  <h3 style="text-align:center">Entr√©e enregistr√©e</h3>

  <p><strong>Acteur :</strong> <span id="s-actor"></span></p>
  <p><strong>Flux :</strong> RECEPTION ‚Üí STOCK</p>

  <strong>Produits :</strong>
  <ul id="s-products"></ul>

  <button onclick="location.reload()">üîÅ Nouvelle entr√©e</button>
</div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwGL-RIRW81fNEvOrOvf_fn80vElficKi3s8oCbcRExyuZJ_74mg6YdjFZAOIwlrkqA/exec";

const scannedProducts = {};
let scanner;
let lastCode=null,lastTime=0,COOLDOWN=1000;

/* params */
const qs = new URLSearchParams(location.search);
actor.value = qs.get("actor") || "";

function showMessage(t,type="error"){
  message.textContent=t;
  message.style.color=type==="success"?"#16a34a":"#dc2626";
  setTimeout(()=>message.textContent="",2000);
}

function checkValid(){
  const ok = actor.value && Object.keys(scannedProducts).length > 0;
  confirmBtn.disabled = !ok;
  confirmBtn.classList.toggle("enabled", ok);
}

scanBtn.onclick = () => {
  scanBtn.style.display="none";
  scanner = new Html5Qrcode("qr-reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:250},onScan);
};

async function onScan(code){
  const now = Date.now();
  if(code===lastCode && now-lastTime<COOLDOWN) return;
  lastCode=code; lastTime=now;

  if(code.startsWith("http")||code.includes("://")){
    showMessage("‚ùå QR invalide"); return;
  }

  const res = await fetch(`${API_URL}?action=product&code=${encodeURIComponent(code)}`);
  const p = await res.json();
  if(!p){ showMessage("‚ùå Produit inconnu"); return; }

  if(!scannedProducts[code]){
    scannedProducts[code]={name:p.name,photo:p.photo,qty:1};
    render();
    showMessage("‚úÖ Produit ajout√©","success");
  }
}

function render(){
  products.innerHTML="";
  for(const c in scannedProducts){
    const p = scannedProducts[c];
    const d = document.createElement("div");
    d.className="product-card";
    d.innerHTML=`
      <img src="${p.photo}">
      <div>
        <strong>${p.name}</strong><br>
        <small>${c}</small><br>
        Qt√© <input type="number" min="1" value="${p.qty}"
          onchange="scannedProducts['${c}'].qty=this.value">
      </div>
      <button class="remove-btn"
        onclick="delete scannedProducts['${c}'];render()">‚ùå</button>
    `;
    products.appendChild(d);
  }
  checkValid();
}

confirmBtn.onclick = async () => {
  confirmBtn.disabled = true;

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        actor: actor.value,
        from: "RECEPTION",
        to: "STOCK",
        products: scannedProducts
      })
    });

    const r = await res.json();

    if(!r.success){
      showMessage("‚ùå " + (r.error || "Erreur entr√©e stock"));
      confirmBtn.disabled=false;
      return;
    }

    showSuccess();
  }catch{
    showMessage("‚ùå Erreur serveur");
    confirmBtn.disabled=false;
  }
};

function showSuccess(){
  document.getElementById("screen-form").classList.add("hidden");
  document.getElementById("screen-success").classList.remove("hidden");

  document.getElementById("s-actor").textContent = actor.value;

  const list = document.getElementById("s-products");
  list.innerHTML = "";

  for(const c in scannedProducts){
    const p = scannedProducts[c];
    const li = document.createElement("li");
    li.textContent = `${p.name} (${c}) x${p.qty}`;
    list.appendChild(li);
  }
}

</script>
</body>
</html>
