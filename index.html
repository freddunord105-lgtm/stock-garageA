<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Entr√©e Stock ‚Äî SAMEMO</title>

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#fff;
  --border:#e5e7eb;
  --disabled:#94a3b8;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
}
.app{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.header{
  text-align:center;
  margin-bottom:20px;
}
.logo{
  font-size:26px;
  font-weight:800;
  color:var(--primary);
}
.subtitle{
  font-size:14px;
  color:#475569;
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
}
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:#ecfeff;
  color:var(--primary);
  font-weight:600;
  margin-bottom:12px;
}
label{
  font-size:13px;
  font-weight:600;
  margin-top:12px;
  display:block;
}
input{
  width:100%;
  padding:14px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid var(--border);
}
input[readonly]{background:#f1f5f9}
button{
  width:100%;
  margin-top:18px;
  padding:16px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}
#scanBtn{background:var(--primary);color:#fff}
#confirmBtn{background:var(--disabled);color:#fff}
#confirmBtn.enabled{background:var(--success)}
#confirmBtn:disabled{cursor:not-allowed}
#scanMessage{text-align:center;font-weight:600;margin-top:10px}
.products{margin-top:16px;display:flex;flex-direction:column;gap:12px}
.product-card{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  display:flex;
  gap:12px;
  align-items:center;
}
.product-card img{
  width:60px;height:60px;border-radius:10px;object-fit:cover
}
.qty{
  width:70px;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
}
.remove-btn{
  background:none;border:none;font-size:20px;cursor:pointer
}
.hidden{display:none}
.success-icon{
  font-size:48px;
  color:var(--success);
  text-align:center;
}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <div class="logo">SAMEMO</div>
  <div class="subtitle">Entr√©e Stock</div>
</div>

<!-- FORM -->
<div id="screen-form" class="card">

  <div class="badge">üì¶ <span id="count">0</span> produit(s)</div>

  <label>Acteur</label>
  <input id="actor" readonly>

  <label>Destination</label>
  <input value="STOCK" readonly>

  <div id="qr-reader" style="width:100%;margin-top:12px;"></div>
  <div id="scanMessage"></div>

  <button type="button" id="scanBtn">üì∑ Scanner un produit</button>

  <div id="products" class="products"></div>

  <button id="confirmBtn" disabled>CONFIRMER L‚ÄôENTR√âE</button>

</div>

<!-- SUCCESS -->
<div id="screen-success" class="card hidden">
  <div class="success-icon">‚úÖ</div>
  <h3 style="text-align:center">Entr√©e enregistr√©e</h3>

  <p><strong>Acteur :</strong> <span id="s-actor"></span></p>

  <strong>Produits :</strong>
  <ul id="s-products"></ul>

  <button onclick="location.reload()">üîÅ Nouvelle entr√©e</button>
</div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const API_URL="TON_URL_APPS_SCRIPT_ICI";
const scannedProducts={};
let scanner;
let lastCode=null,lastTime=0,COOLDOWN=1000;

const qs=new URLSearchParams(location.search);
actor.value=qs.get("actor")||"";

function showMessage(t,type="error"){
  scanMessage.textContent=t;
  scanMessage.style.color=type==="success"?"#16a34a":"#dc2626";
  setTimeout(()=>scanMessage.textContent="",1500);
}

function checkValid(){
  const hasProducts=Object.keys(scannedProducts).length>0;
  const qtyOk=Object.values(scannedProducts).every(p=>p.qty>0);
  confirmBtn.disabled=!(hasProducts&&qtyOk);
  confirmBtn.classList.toggle("enabled",!confirmBtn.disabled);
}

scanBtn.onclick=()=>{
  scanBtn.style.display="none";
  scanner=new Html5Qrcode("qr-reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:250},onScan);
};

async function onScan(code){
  const now=Date.now();
  if(code===lastCode && now-lastTime<COOLDOWN) return;
  lastCode=code; lastTime=now;

  const res=await fetch(`${API_URL}?action=product&code=${encodeURIComponent(code)}`);
  const p=await res.json();
  if(!p){showMessage("Produit inconnu");return;}

  if(!scannedProducts[code]){
    scannedProducts[code]={name:p.name,photo:p.photo,qty:1};
    render();
    showMessage("Produit ajout√©","success");
  }
}

function render(){
  products.innerHTML="";
  for(const c in scannedProducts){
    const p=scannedProducts[c];
    const d=document.createElement("div");
    d.className="product-card";
    d.innerHTML=`
      <img src="${p.photo}">
      <div style="flex:1">
        <strong>${p.name}</strong><br>
        <small>${c}</small><br>
        Qt√© <input class="qty" type="number" min="1" value="${p.qty}"
          onchange="scannedProducts['${c}'].qty=Number(this.value);checkValid()">
      </div>
      <button class="remove-btn"
        onclick="delete scannedProducts['${c}'];render()">‚ùå</button>
    `;
    products.appendChild(d);
  }
  count.textContent=Object.keys(scannedProducts).length;
  checkValid();
}

confirmBtn.onclick=async()=>{
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      actor:actor.value,
      from:"FOURNISSEUR",
      to:"STOCK",
      products:scannedProducts
    })
  });
  showSuccess();
};

function showSuccess(){
  document.getElementById("screen-form").classList.add("hidden");
  document.getElementById("screen-success").classList.remove("hidden");
  document.getElementById("s-actor").textContent=actor.value;
  const ul=document.getElementById("s-products");
  ul.innerHTML="";
  for(const c in scannedProducts){
    const p=scannedProducts[c];
    const li=document.createElement("li");
    li.textContent=`${p.name} (${c}) x${p.qty}`;
    ul.appendChild(li);
  }
}
</script>
</body>
</html>
