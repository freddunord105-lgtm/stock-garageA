<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAMEMO â€” EntrÃ©e Stock (Bac fixe)</title>
<meta name="theme-color" content="#0f766e">

<style>
:root{
  --primary:#0f766e;
  --success:#16a34a;
  --warning:#f59e0b;
  --error:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg)}
.app{max-width:520px;margin:auto;padding:16px}
.header{text-align:center;margin-bottom:12px}
.logo{font-size:26px;font-weight:900;color:var(--primary)}
.subtitle{font-size:14px;color:var(--muted)}
.card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.small{font-size:13px;color:var(--muted)}
.big{font-size:20px;font-weight:900}
.hr{height:1px;background:var(--border);margin:12px 0}
button{width:100%;padding:12px 14px;border:none;border-radius:12px;font-weight:900;cursor:pointer;margin-top:10px}
.primary{background:var(--primary);color:#fff}
.success{background:var(--success);color:#fff}
.ghost{background:#fff;border:1px solid var(--border)}
.hidden{display:none}
.center{text-align:center}
.kpi{display:flex;gap:10px;justify-content:space-between;margin-top:10px}
.kpi>div{flex:1;background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:10px}
.kpi .label{font-size:12px;color:var(--muted);font-weight:900}
.kpi .value{font-size:18px;font-weight:900}
#qr-reader-bac,#qr-reader-prod{width:100%;min-height:260px}
.note{padding:10px;border-radius:12px;background:#f8fafc;border:1px dashed var(--border);font-weight:700}
input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#f1f5f9;font-weight:800}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="logo">SAMEMO</div>
    <div class="subtitle">EntrÃ©e Stock â€” Scan Bac âžœ Scan Produit</div>
  </div>

  <div id="toast" class="card hidden center"></div>

  <!-- SCAN BAC -->
  <div id="screen-bac" class="card">
    <div class="row">
      <div class="big">1) Scanner le bac STOCK</div>
      <button class="ghost" style="width:auto" onclick="resetAll()">â†»</button>
    </div>

    <div class="hr"></div>

    <label class="small">Acteur</label>
    <input id="actor" readonly>

    <button id="btnStartBac" class="primary">ðŸ“· DÃ©marrer scan bac</button>
    <div id="qr-reader-bac" class="hidden"></div>
    <div id="bacMsg" class="center" style="font-weight:900"></div>
  </div>

  <!-- SCAN PRODUIT -->
  <div id="screen-prod" class="card hidden">
    <div class="row">
      <div class="big">2) Scanner le produit</div>
      <button class="ghost" style="width:auto" id="btnBack">â¬…</button>
    </div>

    <div class="hr"></div>

    <div id="info" class="note"></div>

    <div class="kpi">
      <div><div class="label">AjoutÃ©</div><div class="value" id="kpiAdded">0</div></div>
      <div><div class="label">CapacitÃ©</div><div class="value" id="kpiMax">â€”</div></div>
      <div><div class="label">Actuel</div><div class="value" id="kpiCurrent">â€”</div></div>
    </div>

    <button id="btnStartProd" class="primary">ðŸ“· DÃ©marrer scan produit</button>
    <div id="qr-reader-prod" class="hidden"></div>
    <div id="prodMsg" class="center" style="font-weight:900"></div>

    <button id="btnConfirm" class="success hidden">âœ… Confirmer entrÃ©e stock</button>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/** ========= CONFIG ========= **/
const API_GET  = "https://script.google.com/macros/s/AKfycbztkSDDO0KbzJT24yvVXd61nljCNJsSj4UwH9HPgbOz0fSM_SI7xuXffP7FSpMskaNH/exec";
// IMPORTANT: POST doit aller sur le mÃªme /exec (pas /api/...)
const API_POST = API_GET;

// si tu n'as qu'un seul lieu, tu peux mettre un dÃ©faut
const DEFAULT_SITE = "GARAGE_MONTBELIARD";

/** ========= STATE ========= **/
let bacId = "", bacData = null, site = "";
let bacScanner = null, prodScanner = null;
let bacRunning = false, prodRunning = false;
let addedCount = 0;
let lastScan = { code:null, time:0 };
const COOLDOWN_MS = 250;

let productLocked = false, noDetectStreak = 0;
const UNLOCK_AFTER_FAILS = 8;

const $ = id => document.getElementById(id);

/** ========= HELPERS ========= **/
function toast(m, t="success"){
  const e = $("toast");
  e.textContent = m;
  e.style.background = (t==="success") ? "#ecfdf5" : "#fee2e2";
  e.classList.remove("hidden");
  setTimeout(()=>e.classList.add("hidden"), 2200);
}

// Accepte:
// - URL: https://.../?bac=ST-001&site=GARAGE...
// - "BAC=ST-001;SITE=GARAGE..."
// - juste "ST-001"
function parseBacQr(raw){
  const s = String(raw || "").trim();
  if (!s) return { bac:"", site:"" };

  // URL complÃ¨te
  if (s.startsWith("http://") || s.startsWith("https://")) {
    try {
      const u = new URL(s);
      return {
        bac:  (u.searchParams.get("bac") || u.searchParams.get("BAC") || "").trim(),
        site: (u.searchParams.get("site")|| u.searchParams.get("SITE")|| "").trim(),
      };
    } catch {
      return { bac:"", site:"" };
    }
  }

  // format K=V (BAC=...;SITE=...)
  if (s.includes("=")) {
    const parts = s.split(/[;|,]/).map(x=>x.trim()).filter(Boolean);
    const obj = {};
    for (const part of parts){
      const idx = part.indexOf("=");
      if (idx === -1) continue;
      const k = part.slice(0, idx).trim().toUpperCase();
      const v = part.slice(idx + 1).trim();
      obj[k] = v;
    }
    return { bac: (obj.BAC || obj.BAC_ID || "").trim(), site: (obj.SITE || "").trim() };
  }

  // fallback: juste l'id bac
  return { bac: s, site: "" };
}

/** ========= INIT ========= **/
$("actor").value = new URLSearchParams(location.search).get("actor") || "";

// Si tu arrives par URL de la page (pas via scan), on peut prÃ©-remplir (optionnel)
(function preloadFromUrl(){
  const qs = new URLSearchParams(location.search);
  const preBac  = (qs.get("bac")  || "").trim();
  const preSite = (qs.get("site") || "").trim();
  if (preBac) {
    bacId = preBac;
    site  = preSite || DEFAULT_SITE;
  }
})();

function stopBacSafe(){
  if (bacScanner && bacRunning) {
    try { bacScanner.stop(); } catch(_) {}
  }
  bacRunning = false;
}

function stopProdSafe(){
  productLocked = false; noDetectStreak = 0;
  if (prodScanner && prodRunning) {
    try { prodScanner.stop(); } catch(_) {}
  }
  prodRunning = false;
}

function resetAll(){
  stopBacSafe(); stopProdSafe();
  bacId=""; bacData=null; addedCount=0; site="";
  $("screen-bac").classList.remove("hidden");
  $("screen-prod").classList.add("hidden");
  $("btnStartBac").classList.remove("hidden");
  $("qr-reader-bac").classList.add("hidden");
  $("btnStartProd").classList.remove("hidden");
  $("qr-reader-prod").classList.add("hidden");
  $("btnConfirm").classList.add("hidden");
  $("bacMsg").textContent = "";
  $("prodMsg").textContent = "";
}

/** ========= SCAN BAC ========= **/
$("btnStartBac").onclick = async () => {
  try { await navigator.mediaDevices.getUserMedia({ video:true }); }
  catch { return toast("CamÃ©ra refusÃ©e", "error"); }

  $("btnStartBac").classList.add("hidden");
  $("qr-reader-bac").classList.remove("hidden");

  bacScanner = new Html5Qrcode("qr-reader-bac");
  bacScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    onBacScanned
  );
  bacRunning = true;
};

async function onBacScanned(code){
  const n = Date.now();
  if (code === lastScan.code && (n - lastScan.time) < COOLDOWN_MS) return;
  lastScan = { code, time:n };

  const parsed = parseBacQr(code);
  bacId = (parsed.bac || "").trim();
  site  = (parsed.site || "").trim();

  // si QR ne donne pas le site, on met le dÃ©faut (vu que tu n'as qu'un seul lieu)
  if (!site) site = DEFAULT_SITE;

  if (!bacId) return toast("QR bac invalide", "error");

  stopBacSafe();

  const r = await fetch(`${API_GET}?action=bacStock&bac=${encodeURIComponent(bacId)}&site=${encodeURIComponent(site)}`);
  const j = await r.json();
  if (!j.success) return toast(j.error || "Erreur bacStock", "error");

  bacData = j.data;
  openProd();
}

/** ========= UI PROD ========= **/
function openProd(){
  $("screen-bac").classList.add("hidden");
  $("screen-prod").classList.remove("hidden");

  $("info").innerHTML = `<b>${site} â€” Bac ${bacId}</b><br>Produit attendu : ${bacData.PRODUIT_NOM} (${bacData.PRODUIT_CODE})`;
  $("kpiAdded").textContent = "0";
  $("kpiMax").textContent = String(bacData.QTY_MAX ?? "â€”");
  $("kpiCurrent").textContent = String(bacData.QTY_ACTUEL ?? "â€”");
}

/** ========= SCAN PRODUIT ========= **/
$("btnStartProd").onclick = async () => {
  try { await navigator.mediaDevices.getUserMedia({ video:true }); }
  catch { return toast("CamÃ©ra refusÃ©e", "error"); }

  $("btnStartProd").classList.add("hidden");
  $("qr-reader-prod").classList.remove("hidden");

  prodScanner = new Html5Qrcode("qr-reader-prod");
  prodScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    onProdScanned,
    () => {
      if (productLocked && ++noDetectStreak >= UNLOCK_AFTER_FAILS) {
        productLocked = false;
        noDetectStreak = 0;
      }
    }
  );
  prodRunning = true;
};

function onProdScanned(code){
  if (productLocked) return;
  if (!bacData?.PRODUIT_CODE) return;

  if (String(code || "").trim() !== String(bacData.PRODUIT_CODE).trim()) return;

  addedCount++;
  productLocked = true;
  noDetectStreak = 0;

  $("kpiAdded").textContent = String(addedCount);
  $("btnConfirm").classList.remove("hidden");
}

/** ========= CONFIRM ========= **/
$("btnConfirm").onclick = async () => {
  const b = new URLSearchParams();
  b.set("action","updateStockBac");
  b.set("site", site || DEFAULT_SITE);
  b.set("bac", bacId);
  b.set("qtyAdded", String(addedCount));
  b.set("actor", $("actor").value || "");

  const r = await fetch(API_POST, {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: b.toString()
  });

  const j = await r.json();
  if (!j.success) return toast(j.error || "Erreur updateStockBac", "error");

  toast("EntrÃ©e stock enregistrÃ©e");
  resetAll();
};

$("btnBack").onclick = resetAll;

resetAll();
</script>
</body>
</html>
